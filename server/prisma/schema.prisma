generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mongodb"
  /* 
    Данный параметр не нужен в Prisma v7, но MongoDB пока что поддерживается только на v6

    К несчастью, CLI ругаются если этого поля нет, а плагин в VS Code ругается если есть, поэтому

    Для разработки можно его закомментировать, а для bunx prisma db push - раскомментировать
  */
  url      = env("DATABASE_URL")
}

model User {
  // rely on the database generated object id and avoid overriding it manually
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  // telegram user id 
  userId    Int        @unique @db.Long
  /* 
    Более хорошим решением было бы вынести балансы в отдельную коллекцию и добавить код валюты,
    так как в будущем можем захотеть и аукционы делать на разную валюту (например, тон или звезды), и просто балансы юзеров расширить

    Также, Prisma не поддерживает Decimal тип данных на уровне схемы, поэтому юзаем примитивы
  */
  balance   Float      @default(0) @db.Double
  userGifts UserGift[]
}

model Gift {
  id               String     @id @default(auto()) @map("_id") @db.ObjectId
  name             String
  lastIssuedNumber Int        @default(0)
  auctions         Auction[]
  userGifts        UserGift[]
}

model UserGift {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId Int    @db.Long
  giftId String @db.ObjectId
  number Int

  user User @relation(fields: [userId], references: [userId])
  gift Gift @relation(fields: [giftId], references: [id])
}

enum AuctionStatus {
  SCHEDULED 
  IN_PROGRESS
  FINISHED
}

model Auction {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  giftId           String        @db.ObjectId
  round            Int           @default(1)
  roundExpiresAt   DateTime?
  roundDurationSec Int           @default(60)
  supply           Int
  winnersPerRound  Int
  status           AuctionStatus
  createdAt        DateTime      @default(now())

  gift               Gift                @relation(fields: [giftId], references: [id])
  bids               Bid[]
  auctionAntiSniping AuctionAntiSniping?
}

model AuctionAntiSniping {
  id                   String  @id @default(auto()) @map("_id") @db.ObjectId
  auctionId            String  @unique @db.ObjectId
  enabled              Boolean @default(false)
  extensionDurationSec Int     @default(10)
  thresholdSec         Int     @default(3)
  maxExtensions        Int     @default(3)
  currentExtension     Int     @default(1)

  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)
}

enum BidStatus {
  PENDING
  CLOSED
}

model Bid {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  auctionId String    @db.ObjectId
  bidderId  Int       @db.Long
  amount    Float     @db.Double
  status    BidStatus @default(PENDING)
  createdAt DateTime  @default(now())

  auction Auction @relation(fields: [auctionId], references: [id])

  @@index([auctionId, bidderId])
}
