generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mongodb"
  // not needed in prisma v7, but mongo is still on v6, while vs code plugin already expects v7
  // so to start u need to uncomment this and run npx prisma db push, then comment it back if u don't want to see the error 
  // url      = env("DATABASE_URL")
}

model User {
  // rely on the database generated object id and avoid overriding it manually
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  // telegram user id 
  userId    Int        @unique @db.Long
  // a better approach would be a separate collection for balances
  // to support multiple balance types and currencies in the future,
  // but for simplicity we keep a single balance field
  balance   Float      @default(0) @db.Double
  userGifts UserGift[]
}

model Gift {
  id               String     @id @default(auto()) @map("_id") @db.ObjectId
  name             String
  lastIssuedNumber Int        @default(0)
  auctions         Auction[]
  userGifts        UserGift[]
}

model UserGift {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId Int    @db.Long
  giftId String @db.ObjectId
  number Int

  user User @relation(fields: [userId], references: [userId])
  gift Gift @relation(fields: [giftId], references: [id])
}

enum AuctionStatus {
  SCHEDULED 
  IN_PROGRESS
  FINISHED
}

model Auction {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  giftId           String        @db.ObjectId
  round            Int           @default(1)
  roundExpiresAt   DateTime?
  roundDurationSec Int           @default(60)
  supply           Int
  winnersPerRound  Int
  status           AuctionStatus
  createdAt        DateTime      @default(now())

  gift               Gift                @relation(fields: [giftId], references: [id])
  bids               Bid[]
  auctionAntiSniping AuctionAntiSniping?
}

model AuctionAntiSniping {
  id                   String  @id @default(auto()) @map("_id") @db.ObjectId
  auctionId            String  @unique @db.ObjectId
  enabled              Boolean @default(false)
  extensionDurationSec Int     @default(10)
  thresholdSec         Int     @default(3)
  maxExtensions        Int     @default(3)
  currentExtension     Int     @default(1)

  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)
}

enum BidStatus {
  PENDING
  CLOSED
}

model Bid {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  auctionId String    @db.ObjectId
  bidderId  Int       @db.Long
  amount    Float     @db.Double
  status    BidStatus @default(PENDING)
  createdAt DateTime  @default(now())

  auction Auction @relation(fields: [auctionId], references: [id])

  @@index([auctionId, bidderId])
}
